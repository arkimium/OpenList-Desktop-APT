#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all
export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

# Get version and tag from environment or changelog
DEB_VERSION := $(shell dpkg-parsechangelog -S Version | cut -d- -f1)
SOURCE_TAG := v$(DEB_VERSION)

%:
	dh $@

override_dh_auto_build:
	@echo "=== Debian Rules: override_dh_auto_build ==="
	@echo "Package version: $(DEB_VERSION)"
	@echo "Source tag: $(SOURCE_TAG)"
	@echo "Architecture: $(DEB_HOST_ARCH)"
	@echo "Build phase - preparing for installation"

override_dh_auto_install:
	@echo "=== Debian Rules: override_dh_auto_install ==="
	@echo "Looking for binary for architecture: $(DEB_HOST_ARCH)"

	# Define .deb file name based on version and architecture
	DEB_FILE_NAME="OpenList.Desktop_$(DEB_VERSION)_$(DEB_HOST_ARCH).deb"

	# Download the .deb file if it doesn't already exist
	if [ ! -f "$$DEB_FILE_NAME" ]; then \
		echo "Debian package '$$DEB_FILE_NAME' not found, downloading..."; \
		DOWNLOAD_URL="https://github.com/OpenListTeam/OpenList-Desktop/releases/download/$(SOURCE_TAG)/$$DEB_FILE_NAME"; \
		echo "Download URL: $$DOWNLOAD_URL"; \
		wget -O "$$DEB_FILE_NAME" "$$DOWNLOAD_URL" || \
		(echo "Failed to download .deb file from $$DOWNLOAD_URL"; exit 1); \
	fi

	# Extract the .deb file to a temporary directory
	mkdir -p temp_extract
	echo "Extracting '$$DEB_FILE_NAME' to temporary directory...";
	dpkg-deb -x "$$DEB_FILE_NAME" temp_extract;
	echo "Extraction completed.";

	@echo "Checking extracted contents:"
	@ls -la temp_extract/var/lib/openlist/

	# The binary is located at /var/lib/openlist/openlist-desktop inside the .deb
	EXTRACTED_BINARY_PATH="temp_extract/var/lib/openlist/openlist-desktop"

	if [ ! -f "$$EXTRACTED_BINARY_PATH" ]; then \
		echo "Error: openlist-desktop binary not found at '$$EXTRACTED_BINARY_PATH' after extraction"; \
		echo "Contents of extraction directory:"; \
		find temp_extract/ -type f -exec ls -la {} \; || echo "Directory is empty"; \
		exit 1; \
	fi

	# Create the directory structure for the new package
	mkdir -p debian/openlist-desktop/var/lib/openlist
	mkdir -p debian/openlist-desktop/usr/bin
	mkdir -p debian/openlist-desktop/usr/lib/systemd/system

	# Copy the extracted binary to the new package structure
	cp "$$EXTRACTED_BINARY_PATH" debian/openlist-desktop/var/lib/openlist/
	chmod +x debian/openlist-desktop/var/lib/openlist/openlist-desktop

	# Copy the service file
	cp debian/openlist.service debian/openlist-desktop/usr/lib/systemd/system/

	# Create the wrapper script in /usr/bin
	echo '#!/bin/bash' > debian/openlist-desktop/usr/bin/openlist-desktop
	echo '# OpenList Desktop wrapper script' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '# Automatically adds --force-bin-dir to all commands' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo 'BINARY="/var/lib/openlist/openlist-desktop"' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '# Check if the binary exists' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo 'if [ ! -x "$$BINARY" ]; then' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '    echo "Error: OpenList Desktop binary not found at $$BINARY"' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '    exit 1' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo 'fi' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '# Check if --force-bin-dir is already present in arguments' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo 'if [[ "$$*" != *"--force-bin-dir"* ]]; then' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '    # Add --force-bin-dir to all commands' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '    exec "$$BINARY" "$$@" --force-bin-dir' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo 'else' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '    # --force-bin-dir already present, pass through as-is' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo '    exec "$$BINARY" "$$@"' >> debian/openlist-desktop/usr/bin/openlist-desktop
	echo 'fi' >> debian/openlist-desktop/usr/bin/openlist-desktop
	chmod +x debian/openlist-desktop/usr/bin/openlist-desktop

	# Clean up temporary files
	rm -rf temp_extract
	rm -f "$$DEB_FILE_NAME"

	@echo "Files installed to package directory:"
	@find debian/openlist-desktop -type f -exec ls -la {} \;
	@echo "Wrapper script content:"
	@cat debian/openlist-desktop/usr/bin/openlist-desktop

override_dh_install:
	@echo "Skipping dh_install - files already installed manually"

override_dh_usrlocal:
	@echo "Skipping dh_usrlocal - not using /usr/local"

override_dh_strip:
	@echo "Skipping dh_strip - Go binaries are already optimized and don't need stripping"

override_dh_dwz:
	@echo "Skipping dh_dwz - Go binaries don't need DWARF compression"

override_dh_makeshlibs:
	@echo "Skipping dh_makeshlibs - no shared libraries to process"

override_dh_shlibdeps:
	@echo "Skipping dh_shlibdeps - Go binaries are statically linked"

override_dh_auto_clean:
	@echo "=== Debian Rules: override_dh_auto_clean ==="
	rm -f OpenList-Desktop-*.tar.gz
	rm -rf temp_extract
	# Preserve debian/binaries directory during build process
	# It contains pre-downloaded binaries for PPA builds
	@if [ -d "debian/binaries" ]; then \
		echo "Preserving debian/binaries (contains pre-downloaded binaries for PPA)"; \
		echo "Contents of debian/binaries:"; \
		ls -la debian/binaries/ || true; \
	else \
		echo "No debian/binaries directory found"; \
	fi
	dh_auto_clean

override_dh_auto_test:
	@echo "Skipping tests for cross-compilation"

